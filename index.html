<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Birzeit University Campus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      height: 100vh;
      width: 100%;
      position: relative;
    }
    #map {
      position: absolute;
      width: 100%;
      top: 0;
      bottom: 0;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 20px;
      z-index: 1000;
    }
    #collegeSelect {
      max-width: 200px;
    }
    #navigateButton {
      margin-top: 10px;
      display: block;
    }
    .leaflet-routing-container {
      background-color: transparent; /* No background color */
      color: red; /* Font color to red */
      font-size: 12px; /* Smaller font size for route instructions */
      position: relative; /* Ensure proper positioning */
      right: 20px; /* Move the container 20 pixels from the right */
      transform: translate(1%, 80%); /* Move the container 80% of its own height to the bottom */
    }
    @media (min-width: 769px) {
      #controls {
        left: auto;
        right: 20px;
      }
    }
    @media (max-width: 768px) {
      #controls {
        left: 50px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <select id="collegeSelect">
      <option value="">Select College ID</option>
    </select>
    <button id="navigateButton">Take me to my Destination</button>
  </div>
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.js"></script>
  <script>
    const mapOptions = {
      zoomSnap: 0.5,
      center: [31.960055, 35.182576],
      zoom: 17.5,
    };
    const map = L.map("map", mapOptions);

    var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    }).addTo(map);

    var collegeLayer;
    var collegesData;
    var selectedCollege;
    var collegeMarkers = {};

    $.getJSON("colleges_edit.json", function(Colleges) {
      collegesData = Colleges;
      collegeLayer = L.geoJson(Colleges, {
        pointToLayer: function(feature, latlng) {
          var marker = L.circleMarker(latlng, {
            radius: 5,
            fillColor: "blue",
            color: "blue",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          }).addTo(map);
          marker.bindPopup("College ID: " + feature.properties.college_ID);
          collegeMarkers[feature.properties.college_ID] = marker;
          marker.remove(); // Hide marker initially
          return marker;
        }
      });

      Colleges.features.forEach(function(feature) {
        $('#collegeSelect').append(new Option(feature.properties.college_ID, feature.properties.college_ID));
      });
    }).fail(function(jqxhr, textStatus, error) {
      console.error("Error loading colleges_edit.json: ", textStatus, error);
    });

    $('#collegeSelect').change(function() {
      var selectedId = $(this).val();
      if (!selectedId) return;

      var selectedFeature = collegesData.features.find(function(feature) {
        return feature.properties.college_ID == selectedId;
      });

      if (selectedFeature) {
        var latlng = L.latLng(selectedFeature.geometry.coordinates[1], selectedFeature.geometry.coordinates[0]);
        map.setView(latlng, 18);

        // Hide all markers
        for (var key in collegeMarkers) {
          collegeMarkers[key].remove();
        }

        // Show the selected marker and open its popup
        var selectedMarker = collegeMarkers[selectedId];
        selectedMarker.addTo(map);
        selectedMarker.openPopup();

        selectedCollege = selectedFeature;
      }
    });

    $('#navigateButton').click(function() {
      map.locate({setView: true, maxZoom: 16});
    });

    map.on('locationfound', function(e) {
      var myLocation = e.latlng;
      if (!selectedCollege) return;

      var destination = L.latLng(selectedCollege.geometry.coordinates[1], selectedCollege.geometry.coordinates[0]);

      L.Routing.control({
        waypoints: [
          myLocation,
          destination
        ],
        routeWhileDragging: true
      }).addTo(map);
    });
  </script>
</body>
</html>
