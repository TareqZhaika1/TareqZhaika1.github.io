<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Birzeit University Campus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      height: 100vh;
      width: 100%;
      position: relative;
      font-family: Arial, sans-serif;
    }
    #map {
      position: absolute;
      width: 100%;
      top: 0;
      bottom: 0;
    }
    #travelModeContainer {
      position: absolute;
      top: 50px;
      right: 20px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      gap: 10px;
    }
    .travelMode {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 5px;
    }
    .travelMode img {
      width: 32px;
      height: 32px;
    }
    .travelMode span {
      font-size: 12px;
      margin-top: 5px;
    }
    .travelMode.active {
      border-bottom: 2px solid blue;
    }
    #directions {
      position: absolute;
      top: 130px;
      right: 20px;
      z-index: 1000;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      width: 300px;
      display: none; /* Hide initially */
    }
    .direction-step {
      margin: 5px 0;
      font-size: 14px;
      line-height: 1.5;
    }
    .leaflet-control-zoom {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
    }
    .summary {
      font-weight: bold;
      margin-bottom: 10px;
    }
    #fileSelect {
      position: absolute;
      top: 10px;
      right: 120px;
      z-index: 1000;
    }
    #idSelect {
      position: absolute;
      top: 10px;
      right: 20px;
      z-index: 1000;
      display: none; /* Hide initially */
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <select id="fileSelect">
    <option value="">Select your Destination</option>
    <option value="colleges_edit.json">Colleges</option>
    <option value="caf.json">Cafeterias</option>
  </select>
  <select id="idSelect">
    <option value="">Select ID</option>
  </select>
  <div id="travelModeContainer">
    <div id="walkingMode" class="travelMode active" data-mode="walking">
      <img src="https://img.icons8.com/ios-filled/50/000000/walking.png" alt="Walking">
      <span>Walking</span>
    </div>
    <div id="carMode" class="travelMode" data-mode="car">
      <img src="https://img.icons8.com/ios-filled/50/000000/car.png" alt="Car">
      <span>By Car</span>
    </div>
  </div>
  <div id="directions"></div>
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/@mapbox/polyline@1.0.0/src/polyline.js"></script>
  <script>
    const mapOptions = {
      zoomSnap: 0.5,
      center: [31.960055, 35.182576],
      zoom: 17.5,
    };
    const map = L.map("map", mapOptions);

    var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    }).addTo(map);

    var collegeMarkers = {};
    var cafesMarkers = {};
    var collegesData;
    var cafesData;

    $.getJSON("colleges_edit.json", function(data) {
      collegesData = data;
      data.features.forEach(function(feature) {
        var latlng = L.latLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
        var marker = L.circleMarker(latlng, {
          radius: 8,
          fillColor: "#f28a8a",
          color: "#f28a8a",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
        }).bindPopup("College ID: " + feature.properties.college_ID);
        collegeMarkers[feature.properties.college_ID] = marker;
      });
    }).fail(function(jqxhr, textStatus, error) {
      console.error("Error loading colleges_edit.json: ", textStatus, error);
    });

    $.getJSON("caf.json", function(data) {
      cafesData = data;
      data.features.forEach(function(feature) {
        var latlng = L.latLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
        var marker = L.circleMarker(latlng, {
          radius: 8,
          fillColor: "#f28a8a",
          color: "#f28a8a",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
        }).bindPopup("Cafe ID: " + feature.properties.Cafe_ID);
        cafesMarkers[feature.properties.Cafe_ID] = marker;
      });
    }).fail(function(jqxhr, textStatus, error) {
      console.error("Error loading caf.json: ", textStatus, error);
    });

    var selectedFile = null;
    var selectedID = null;
    var routingControl = null; // To keep track of the routing control
    var selectedMarker = null; // To keep track of the selected marker
    var travelMode = 'walking';

    $('.travelMode').click(function() {
      $('.travelMode').removeClass('active');
      $(this).addClass('active');
      travelMode = $(this).data('mode');
      if (selectedID) {
        map.locate({setView: false, maxZoom: 16}); // Set setView to false and trigger route calculation
      }
    });

    $('#fileSelect').change(function() {
      var selectedValue = $(this).val();
      selectedFile = selectedValue;
      $('#idSelect').empty().append(new Option('Select ID', ''));
      if (selectedValue === 'colleges_edit.json') {
        for (var id in collegeMarkers) {
          $('#idSelect').append(new Option(id, id));
        }
      } else if (selectedValue === 'caf.json') {
        for (var id in cafesMarkers) {
          $('#idSelect').append(new Option(id, id));
        }
      }
      $('#idSelect').show();
    });

    $('#idSelect').change(function() {
      var selectedId = $(this).val();
      selectedID = selectedId;
      if (!selectedId) {
        if (selectedMarker !== null) {
          selectedMarker.remove();
          selectedMarker = null;
        }
        $('#idSelect').hide();
        return;
      }

      var data = selectedFile === 'colleges_edit.json' ? collegesData : cafesData;
      var selectedFeature = data.features.find(function(feature) {
        return feature.properties[selectedFile === 'colleges_edit.json' ? 'college_ID' : 'Cafe_ID'] == selectedId;
      });

      if (selectedFeature) {
        var latlng = L.latLng(selectedFeature.geometry.coordinates[1], selectedFeature.geometry.coordinates[0]);

        if (selectedMarker !== null) {
          selectedMarker.remove();
          selectedMarker = null;
        }
        if (routingControl !== null) {
          routingControl.getPlan().setWaypoints([]);
          routingControl.remove();
          routingControl = null;
        }

        selectedMarker = selectedFile === 'colleges_edit.json' ? collegeMarkers[selectedId] : cafesMarkers[selectedId];
        selectedMarker.addTo(map);
        map.flyTo(latlng, 18);
        selectedMarker.openPopup();

        $('#directions').hide();
      }
    });

    function updateDirections(route) {
      const directionsContainer = document.getElementById('directions');
      directionsContainer.innerHTML = ''; // Clear previous directions

      const summary = route.summary;
      const totalDistance = summary.totalDistance < 1000 ? `${summary.totalDistance.toFixed(0)} m` : `${(summary.totalDistance / 1000).toFixed(2)} km`;
      const totalMinutes = Math.round(summary.totalTime / 60); // convert to minutes
      const totalHours = Math.floor(totalMinutes / 60); // calculate hours
      const remainingMinutes = totalMinutes % 60; // calculate remaining minutes
      const totalTime = totalHours > 0 ? `${totalHours} hr ${remainingMinutes} min` : `${totalMinutes} min`; // display in hours and minutes if hours > 0

      const summaryElement = document.createElement('div');
      summaryElement.className = 'summary';
      summaryElement.innerText = `Distance: ${totalDistance}, Time: ${totalTime}`;
      directionsContainer.appendChild(summaryElement);

      for (let i = 0; i < Math.min(route.instructions.length, 3); i++) {
        const step = route.instructions[i];
        const stepDistance = step.distance < 1000 ? `${step.distance.toFixed(0)} m` : `${(step.distance / 1000).toFixed(2)} km`;
        const stepElement = document.createElement('div');
        stepElement.className = 'direction-step';
        stepElement.innerText = `${i + 1}. ${step.text} (${stepDistance})`; // Added numbering
        directionsContainer.appendChild(stepElement);
      }
    }

    map.on('locationfound', function(e) {
      var myLocation = e.latlng;
      if (selectedID) {
        var data = selectedFile === 'colleges_edit.json' ? collegesData : cafesData;
        var selectedFeature = data.features.find(function(feature) {
          return feature.properties[selectedFile === 'colleges_edit.json' ? 'college_ID' : 'Cafe_ID'] == selectedID;
        });
        var destination = L.latLng(selectedFeature.geometry.coordinates[1], selectedFeature.geometry.coordinates[0]);

        if (routingControl !== null) {
          routingControl.getPlan().setWaypoints([]);
          routingControl.remove();
        }

        var routerOptions = {
          profile: travelMode === 'walking' ? 'mapbox/walking' : 'mapbox/driving'
        };

        routingControl = L.Routing.control({
          waypoints: [
            L.Routing.waypoint(myLocation, {draggable: true}),
            L.Routing.waypoint(destination, {draggable: true})
          ],
          router: L.Routing.mapbox('pk.eyJ1IjoidGFyZXF6aGFpa2EiLCJhIjoiY2x3cDZ4b2VnMWk0dTJxczFmdXE0Y3MwcCJ9.yWtxunGkYaYZDtvjtAt-ww', routerOptions),
          createMarker: function(i, waypoint) {
            return L.marker(waypoint.latLng, {
              draggable: true,
              icon: L.icon({
                iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/images/marker-icon.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/images/marker-shadow.png',
                shadowSize: [41, 41]
              })
            });
          },
          routeWhileDragging: true,
          showAlternatives: false,
          lineOptions: {
            addWaypoints: true // Allow adding waypoints by dragging
          },
          // Remove the default itinerary
          itinerary: {
            containerClassName: 'custom-itinerary',
            show: false
          }
        }).on('routesfound', function(e) {
          const routes = e.routes;
          if (routes.length > 0) {
            updateDirections(routes[0]);
          }
        }).addTo(map);

        document.querySelector('.leaflet-routing-container').style.display = 'none';
        document.getElementById('directions').style.display = 'block';
        var bounds = L.latLngBounds([myLocation, destination]);
        map.fitBounds(bounds);
      }
    });

    map.on('locationerror', function(e) {
      alert("Location access denied.");
    });
  </script>
</body>
</html>
