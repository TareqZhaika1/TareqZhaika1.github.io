<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Birzeit University Campus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      height: 100vh;
      width: 100%;
      position: relative;
    }
    #map {
      position: absolute;
      width: 100%;
      top: 0;
      bottom: 0;
    }
    #collegeSelect {
      position: absolute;
      top: 10px;
      left: 20px;
      z-index: 1000;
    }
    #locateButton {
      position: absolute;
      top: 50px;
      left: 20px;
      z-index: 1000;
    }
    .leaflet-routing-container {
        background-color: transparent;
        color: red;
        font-size: 12px;
        position: relative;
        right: 20px;
        transform: translate(1%, 80%);
    }
    @media (min-width: 769px) {
      #collegeSelect {
        left: auto;
        right: 20px;
      }
      #locateButton {
        left: auto;
        right: 20px;
        top: 60px;
      }
    }
    @media (max-width: 768px) {
      #collegeSelect {
        left: 50px;
      }
      #locateButton {
        left: 50px;
        top: 80px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <select id="collegeSelect">
    <option value="">Select College ID</option>
  </select>
  <button id="locateButton">Take me to my Destination</button>
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.js"></script>
  <script>
    const mapOptions = {
      zoomSnap: 0.5,
      center: [31.960055, 35.182576],
      zoom: 17.5,
    };
    const map = L.map("map", mapOptions);

    var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    }).addTo(map);

    var collegeMarkers = {};
    var collegesData;

    $.getJSON("colleges_edit.json", function(Colleges) {
      collegesData = Colleges;
      Colleges.features.forEach(function(feature) {
        var latlng = L.latLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
        var marker = L.circleMarker(latlng, {
          radius: 5,
          fillColor: "blue",
          color: "blue",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
        }).bindPopup("College ID: " + feature.properties.college_ID);
        collegeMarkers[feature.properties.college_ID] = marker;

        // Add options to the dropdown menu
        $('#collegeSelect').append(new Option(feature.properties.college_ID, feature.properties.college_ID));
      });
    }).fail(function(jqxhr, textStatus, error) {
      console.error("Error loading colleges_edit.json: ", textStatus, error);
    });

    var selectedCollege = null;
    var routingControl = null; // To keep track of the routing control
    var selectedMarker = null; // To keep track of the selected college marker

    $('#collegeSelect').change(function() {
      var selectedId = $(this).val();
      if (!selectedId) return;

      var selectedFeature = collegesData.features.find(function(feature) {
        return feature.properties.college_ID == selectedId;
      });

      if (selectedFeature) {
        var latlng = L.latLng(selectedFeature.geometry.coordinates[1], selectedFeature.geometry.coordinates[0]);
        
        // Remove the previous selected marker and routing control if they exist
        if (selectedMarker !== null) {
          selectedMarker.remove();
        }
        if (routingControl !== null) {
          routingControl.removeFrom(map);
        }
        
        // Ensure the selected marker is added to the map before setting the view
        selectedMarker = collegeMarkers[selectedId];
        selectedMarker.addTo(map);
        
        // Center the map on the selected marker with flyTo
        map.flyTo(latlng, 18);
        selectedMarker.openPopup();

        // Set the selected college
        selectedCollege = selectedFeature;
      }
    });

    $('#locateButton').click(function() {
      if (!selectedCollege) {
        alert("Please select a college first.");
        return;
      }
      map.locate({setView: false, maxZoom: 16}); // Set setView to false
    });

    map.on('locationfound', function(e) {
      var myLocation = e.latlng;
      if (selectedCollege) {
        var destination = L.latLng(selectedCollege.geometry.coordinates[1], selectedCollege.geometry.coordinates[0]);
        
        // Remove previous routing control if exists
        if (routingControl !== null) {
          routingControl.removeFrom(map);
        }

        // Add new routing control
        routingControl = L.Routing.control({
          waypoints: [
            myLocation,
            destination
          ]
        }).addTo(map);

        // Fit the map to the calculated bounds
        var bounds = L.latLngBounds([myLocation, destination]);
        map.fitBounds(bounds);
      }
    });

    map.on('locationerror', function(e) {
      alert("Location access denied.");
    });
  </script>
</body>
</html>
